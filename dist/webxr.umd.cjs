(function(h,k){typeof exports=="object"&&typeof module<"u"?k(exports,require("@lookingglass/webxr-polyfill/src/api/index"),require("@lookingglass/webxr-polyfill/src/api/XRSystem"),require("@lookingglass/webxr-polyfill/src/WebXRPolyfill"),require("holoplay-core"),require("@lookingglass/webxr-polyfill/src/devices/XRDevice"),require("@lookingglass/webxr-polyfill/src/api/XRSpace"),require("gl-matrix"),require("@lookingglass/webxr-polyfill/src/api/XRWebGLLayer")):typeof define=="function"&&define.amd?define(["exports","@lookingglass/webxr-polyfill/src/api/index","@lookingglass/webxr-polyfill/src/api/XRSystem","@lookingglass/webxr-polyfill/src/WebXRPolyfill","holoplay-core","@lookingglass/webxr-polyfill/src/devices/XRDevice","@lookingglass/webxr-polyfill/src/api/XRSpace","gl-matrix","@lookingglass/webxr-polyfill/src/api/XRWebGLLayer"],k):(h=typeof globalThis<"u"?globalThis:h||self,k(h["Looking Glass WebXR"]={},h["@lookingglass/webxr-polyfill/src/api/index"],h["@lookingglass/webxr-polyfill/src/api/XRSystem"],h["@lookingglass/webxr-polyfill/src/WebXRPolyfill"],h.holoPlayCore,h["@lookingglass/webxr-polyfill/src/devices/XRDevice"],h["@lookingglass/webxr-polyfill/src/api/XRSpace"],h.glMatrix,h["@lookingglass/webxr-polyfill/src/api/XRWebGLLayer"]))})(this,function(h,k,B,ne,H,ie,ae,w,$){"use strict";var Xe=Object.defineProperty;var We=(h,k,B)=>k in h?Xe(h,k,{enumerable:!0,configurable:!0,writable:!0,value:B}):h[k]=B;var C=(h,k,B)=>(We(h,typeof k!="symbol"?k+"":k,B),B);const V=t=>t&&typeof t=="object"&&"default"in t?t:{default:t};function re(t){if(t&&t.__esModule)return t;const i=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(t){for(const e in t)if(e!=="default"){const r=Object.getOwnPropertyDescriptor(t,e);Object.defineProperty(i,e,r.get?r:{enumerable:!0,get:()=>t[e]})}}return i.default=t,Object.freeze(i)}const Z=V(k),se=V(B),oe=V(ne),le=re(H),ce=V(ie),ue=V(ae),de=V($),q=1.6;var Y;(function(t){t[t.Swizzled=0]="Swizzled",t[t.Center=1]="Center",t[t.Quilt=2]="Quilt"})(Y||(Y={}));class fe extends EventTarget{constructor(e){super();C(this,"_calibration",{configVersion:"1.0",pitch:{value:45},slope:{value:-5},center:{value:-.5},viewCone:{value:40},invView:{value:1},verticalAngle:{value:0},DPI:{value:338},screenW:{value:250},screenH:{value:250},flipImageX:{value:0},flipImageY:{value:0},flipSubp:{value:0},serial:"LKG-DEFAULT-#####"});C(this,"_viewControls",{tileHeight:512,numViews:48,trackballX:0,trackballY:0,targetX:0,targetY:q,targetZ:-.5,targetDiam:2,fovy:13/180*Math.PI,depthiness:1.25,inlineView:Y.Center,capturing:!1,quiltResolution:3840,popup:null,XRSession:null,lkgCanvas:null,appCanvas:null});C(this,"LookingGlassDetected");this._viewControls={...this._viewControls,...e},this.syncCalibration()}syncCalibration(){new le.Client(e=>{if(e.devices.length<1){console.log("No Looking Glass devices found");return}e.devices.length>1&&console.log("More than one Looking Glass device found... using the first one"),this.calibration=e.devices[0].calibration})}addEventListener(e,r,n){super.addEventListener(e,r,n)}onConfigChange(){this.dispatchEvent(new Event("on-config-changed"))}get calibration(){return this._calibration}set calibration(e){this._calibration={...this._calibration,...e},this.onConfigChange()}updateViewControls(e){e!=null&&(this._viewControls={...this._viewControls,...e},this.onConfigChange())}get tileHeight(){return Math.round(this.framebufferHeight/this.quiltHeight)}get quiltResolution(){return this._viewControls.quiltResolution}set quiltResolution(e){this.updateViewControls({quiltResolution:e})}get numViews(){return this.quiltWidth*this.quiltHeight}get targetX(){return this._viewControls.targetX}set targetX(e){this.updateViewControls({targetX:e})}get targetY(){return this._viewControls.targetY}set targetY(e){this.updateViewControls({targetY:e})}get targetZ(){return this._viewControls.targetZ}set targetZ(e){this.updateViewControls({targetZ:e})}get trackballX(){return this._viewControls.trackballX}set trackballX(e){this.updateViewControls({trackballX:e})}get trackballY(){return this._viewControls.trackballY}set trackballY(e){this.updateViewControls({trackballY:e})}get targetDiam(){return this._viewControls.targetDiam}set targetDiam(e){this.updateViewControls({targetDiam:e})}get fovy(){return this._viewControls.fovy}set fovy(e){this.updateViewControls({fovy:e})}get depthiness(){return this._viewControls.depthiness}set depthiness(e){this.updateViewControls({depthiness:e})}get inlineView(){return this._viewControls.inlineView}set inlineView(e){this.updateViewControls({inlineView:e})}get capturing(){return this._viewControls.capturing}set capturing(e){this.updateViewControls({capturing:e})}get popup(){return this._viewControls.popup}set popup(e){this.updateViewControls({popup:e})}get XRSession(){return this._viewControls.XRSession}set XRSession(e){this.updateViewControls({XRSession:e})}get lkgCanvas(){return this._viewControls.lkgCanvas}set lkgCanvas(e){this.updateViewControls({lkgCanvas:e})}get appCanvas(){return this._viewControls.appCanvas}set appCanvas(e){this.updateViewControls({appCanvas:e})}get aspect(){return this._calibration.screenW.value/this._calibration.screenH.value}get tileWidth(){return Math.round(this.framebufferWidth/this.quiltWidth)}get framebufferWidth(){return this._calibration.screenW.value<7e3?this._viewControls.quiltResolution:7680}get quiltWidth(){return this.calibration.screenW.value==1536?8:this.calibration.screenW.value==3840||this.calibration.screenW.value>7e3?5:8}get quiltHeight(){return this.calibration.screenW.value==1536?6:this.calibration.screenW.value==3840||this.calibration.screenW.value>7e3?9:6}get framebufferHeight(){return this._calibration.screenW.value<7e3?this._viewControls.quiltResolution:4320}get viewCone(){return this._calibration.viewCone.value*this.depthiness/180*Math.PI}get tilt(){return this._calibration.screenH.value/(this._calibration.screenW.value*this._calibration.slope.value)*(this._calibration.flipImageX.value?-1:1)}set tilt(e){}get subp(){return 1/(this._calibration.screenW.value*3)}get pitch(){const e=this._calibration.screenW.value/this._calibration.DPI.value;return this._calibration.pitch.value*e*Math.cos(Math.atan(1/this._calibration.slope.value))}}let j=null;function S(){return j==null&&(j=new fe),j}function Q(t){const i=S();t!=null&&i.updateViewControls(t)}async function he(){const t=S();let i=2;function e(){if(t.appCanvas!=null)try{let n=t.appCanvas.toDataURL();const l=document.createElement("a");l.style.display="none",l.href=n,l.download=`hologram_qs${t.quiltWidth}x${t.quiltHeight}a${t.aspect}.png`,document.body.appendChild(l),l.click(),document.body.removeChild(l),window.URL.revokeObjectURL(n)}catch(n){console.error("Error while capturing canvas data:",n)}finally{t.inlineView=i}}const r=document.getElementById("screenshotbutton");r&&r.addEventListener("click",()=>{i=t.inlineView;const n=W.getInstance();if(!n){console.warn("LookingGlassXRDevice not initialized");return}t.inlineView=2,n.captureScreenshot=!0,setTimeout(()=>{n.screenshotCallback=e},100)})}function pe(){var i;const t=S();if(console.log(t,"for debugging purposes"),t.lkgCanvas==null)console.warn("window placement called without a valid XR Session!");else{let e=function(){let s=p.d-p.a,c=p.w-p.s;s&&c&&(s*=Math.sqrt(.5),c*=Math.sqrt(.5));const d=t.trackballX,R=t.trackballY,L=Math.cos(d)*s-Math.sin(d)*Math.cos(R)*c,A=-Math.sin(R)*c,I=-Math.sin(d)*s-Math.cos(d)*Math.cos(R)*c;t.targetX=t.targetX+L*t.targetDiam*.03,t.targetY=t.targetY+A*t.targetDiam*.03,t.targetZ=t.targetZ+I*t.targetDiam*.03,requestAnimationFrame(e)};const r=document.createElement("style");document.head.appendChild(r),(i=r.sheet)==null||i.insertRule("#LookingGlassWebXRControls * { all: revert; font-family: sans-serif }");const n=document.createElement("div");n.id="LookingGlassWebXRControls",n.style.position="fixed",n.style.zIndex="1000",n.style.padding="15px",n.style.width="320px",n.style.maxWidth="calc(100vw - 18px)",n.style.maxHeight="calc(100vh - 18px)",n.style.whiteSpace="nowrap",n.style.background="rgba(0, 0, 0, 0.6)",n.style.color="white",n.style.borderRadius="10px",n.style.right="15px",n.style.bottom="15px",n.style.flex="row";const l=document.createElement("div");n.appendChild(l),l.style.width="100%",l.style.textAlign="center",l.style.fontWeight="bold",l.style.marginBottom="8px",l.innerText="Looking Glass Controls";const o=document.createElement("button");o.style.display="block",o.style.margin="auto",o.style.width="100%",o.style.height="35px",o.style.padding="4px",o.style.marginBottom="8px",o.style.borderRadius="8px",o.id="screenshotbutton",n.appendChild(o),o.innerText="Save Hologram";const u=document.createElement("button");u.style.display="block",u.style.margin="auto",u.style.width="100%",u.style.height="35px",u.style.padding="4px",u.style.marginBottom="8px",u.style.borderRadius="8px",u.id="copybutton",n.appendChild(u),u.innerText="Copy Config",u.addEventListener("click",()=>{me(t)});const v=document.createElement("div");n.appendChild(v),v.style.width="290px",v.style.whiteSpace="normal",v.style.color="rgba(255,255,255,0.7)",v.style.fontSize="14px",v.style.margin="5px 0",v.innerHTML="Click the popup and use WASD, mouse left/right drag, and scroll.";const _=document.createElement("div");n.appendChild(_);const F=(s,c,d)=>{const R=d.stringify,L=document.createElement("div");L.style.marginBottom="8px",_.appendChild(L);const A=s,I=t[s],y=document.createElement("label");L.appendChild(y),y.innerText=d.label,y.setAttribute("for",A),y.style.width="100px",y.style.display="inline-block",y.style.textDecoration="dotted underline 1px",y.style.fontFamily='"Courier New"',y.style.fontSize="13px",y.style.fontWeight="bold",y.title=d.title;const m=document.createElement("input");L.appendChild(m),Object.assign(m,c),m.id=A,m.title=d.title,m.value=c.value!==void 0?c.value:I;const X=b=>{t[s]=b,M(b)};m.oninput=()=>{const b=c.type==="range"?parseFloat(m.value):c.type==="checkbox"?m.checked:m.value;X(b)};const N=b=>{let P=b(t[s]);d.fixRange&&(P=d.fixRange(P),m.max=Math.max(parseFloat(m.max),P).toString(),m.min=Math.min(parseFloat(m.min),P).toString()),m.value=P,X(P)};c.type==="range"&&(m.style.width="110px",m.style.height="8px",m.onwheel=b=>{N(P=>P+Math.sign(b.deltaX-b.deltaY)*c.step)});let M=b=>{};if(R){const b=document.createElement("span");b.style.fontFamily='"Courier New"',b.style.fontSize="13px",b.style.marginLeft="3px",L.appendChild(b),M=P=>{b.innerHTML=R(P)},M(I)}return N};F("fovy",{type:"range",min:1/180*Math.PI,max:120.1/180*Math.PI,step:1/180*Math.PI},{label:"fov",title:"perspective fov (degrades stereo effect)",fixRange:s=>Math.max(1/180*Math.PI,Math.min(s,120.1/180*Math.PI)),stringify:s=>{const c=s/Math.PI*180,d=Math.atan(Math.tan(s/2)*t.aspect)*2/Math.PI*180;return`${c.toFixed()}&deg;&times;${d.toFixed()}&deg;`}}),F("depthiness",{type:"range",min:0,max:2,step:.01},{label:"depthiness",title:"exaggerates depth by multiplying the width of the view cone (as reported by the firmware) - can somewhat compensate for depthiness lost using higher fov.",fixRange:s=>Math.max(0,s),stringify:s=>`${s.toFixed(2)}x`}),F("inlineView",{type:"range",min:0,max:2,step:1},{label:"inline view",title:"what to show inline on the original canvas (swizzled = no overwrite)",fixRange:s=>Math.max(0,Math.min(s,2)),stringify:s=>s===0?"swizzled":s===1?"center":s===2?"quilt":"?"}),t.lkgCanvas.oncontextmenu=s=>{s.preventDefault()},t.lkgCanvas.addEventListener("wheel",s=>{const c=t.targetDiam,d=1.1,R=Math.log(c)/Math.log(d);return t.targetDiam=Math.pow(d,R+s.deltaY*.01)}),t.lkgCanvas.addEventListener("mousemove",s=>{const c=s.movementX,d=-s.movementY;if(s.buttons&2||s.buttons&1&&(s.shiftKey||s.ctrlKey)){const R=t.trackballX,L=t.trackballY,A=-Math.cos(R)*c+Math.sin(R)*Math.sin(L)*d,I=-Math.cos(L)*d,y=Math.sin(R)*c+Math.cos(R)*Math.sin(L)*d;t.targetX=t.targetX+A*t.targetDiam*.001,t.targetY=t.targetY+I*t.targetDiam*.001,t.targetZ=t.targetZ+y*t.targetDiam*.001}else s.buttons&1&&(t.trackballX=t.trackballX-c*.01,t.trackballY=t.trackballY-d*.01)});const p={w:0,a:0,s:0,d:0};return t.lkgCanvas.addEventListener("keydown",s=>{switch(s.code){case"KeyW":p.w=1;break;case"KeyA":p.a=1;break;case"KeyS":p.s=1;break;case"KeyD":p.d=1;break}}),t.lkgCanvas.addEventListener("keyup",s=>{switch(s.code){case"KeyW":p.w=0;break;case"KeyA":p.a=0;break;case"KeyS":p.s=0;break;case"KeyD":p.d=0;break}}),requestAnimationFrame(e),setTimeout(()=>{he()},1e3),n}}function me(t){const i={targetX:t.targetX,targetY:t.targetY,targetZ:t.targetZ,fovy:`${Math.round(t.fovy/Math.PI*180)} * Math.PI / 180`,targetDiam:t.targetDiam,trackballX:t.trackballX,trackballY:t.trackballY,depthiness:t.depthiness};let e=JSON.stringify(i,null,4).replace(/"/g,"").replace(/{/g,"").replace(/}/g,"");navigator.clipboard.writeText(e)}let O;const be=(t,i)=>{const e=S();if(e.lkgCanvas==null){console.warn("window placement called without a valid XR Session!");return}else if(t==!1)we(e,O);else{O==null&&(O=pe()),e.lkgCanvas.style.position="fixed",e.lkgCanvas.style.bottom="0",e.lkgCanvas.style.left="0",e.lkgCanvas.width=e.calibration.screenW.value,e.lkgCanvas.height=e.calibration.screenH.value,document.body.appendChild(O);const r="getScreenDetails"in window;console.log(r,"Screen placement API exists"),r?ve(e.lkgCanvas,e,i):J(e,e.lkgCanvas,i)}};async function ve(t,i,e){const r=await window.getScreenDetails();console.log(r);const n=r.screens.filter(l=>l.label.includes("LKG"))[0];if(console.log(n,"monitors"),n===void 0){console.log("no Looking Glass monitor detected - manually opening popup window"),J(i,t,e);return}else{console.log("monitor ID",n.label,"serial number",i.calibration);const l=[`left=${n.left}`,`top=${n.top}`,`width=${n.width}`,`height=${n.height}`,"menubar=no","toolbar=no","location=no","status=no","resizable=yes","scrollbars=no","fullscreenEnabled=true"].join(",");i.popup=window.open("","new",l),i.popup&&(i.popup.document.body.style.background="black",i.popup.document.body.style.transform="1.0",ee(i),i.popup.document.body.appendChild(t),console.assert(e),i.popup.onbeforeunload=e)}}function J(t,i,e){t.popup=window.open("",void 0,"width=640,height=360"),t.popup&&(t.popup.document.title="Looking Glass Window (fullscreen me on Looking Glass!)",t.popup.document.body.style.background="black",t.popup.document.body.style.transform="1.0",ee(t),t.popup.document.body.appendChild(i),console.assert(e),t.popup.onbeforeunload=e)}function we(t,i){var e;(e=i.parentElement)==null||e.removeChild(i),t.popup&&(t.popup.onbeforeunload=null,t.popup.close(),t.popup=null)}function ee(t){t.popup&&t.popup.document.addEventListener("keydown",i=>{i.ctrlKey&&(i.key==="="||i.key==="-"||i.key==="+")&&i.preventDefault()})}const D=Symbol("LookingGlassXRWebGLLayer");class ye extends de.default{constructor(i,e,r){super(i,e,r);const n=S();n.appCanvas=e.canvas,n.lkgCanvas=document.createElement("canvas"),n.lkgCanvas.tabIndex=0;const l=n.lkgCanvas.getContext("2d",{alpha:!1});n.lkgCanvas.addEventListener("dblclick",function(){this.requestFullscreen()});const o=this[$.PRIVATE].config,u=e.createTexture();let v,_;const F=e.createFramebuffer(),p=e.getExtension("OES_vertex_array_object"),s=34229,c=p?p.bindVertexArrayOES.bind(p):e.bindVertexArray.bind(e);(o.depth||o.stencil)&&(o.depth&&o.stencil?_={format:e.DEPTH_STENCIL,attachment:e.DEPTH_STENCIL_ATTACHMENT}:o.depth?_={format:e.DEPTH_COMPONENT16,attachment:e.DEPTH_ATTACHMENT}:o.stencil&&(_={format:e.STENCIL_INDEX8,attachment:e.STENCIL_ATTACHMENT}),v=e.createRenderbuffer());const d=(a,T,g,f,E)=>{R(a,T,E.framebufferWidth,E.framebufferHeight),g&&L(a,g,f,E.framebufferWidth,E.framebufferHeight)},R=(a,T,g,f)=>{const E=a.getParameter(a.TEXTURE_BINDING_2D);a.bindTexture(a.TEXTURE_2D,T),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,g,f,0,a.RGBA,a.UNSIGNED_BYTE,null),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR),a.bindTexture(a.TEXTURE_2D,E)},L=(a,T,g,f,E)=>{const x=a.getParameter(a.RENDERBUFFER_BINDING);a.bindRenderbuffer(a.RENDERBUFFER,T),a.renderbufferStorage(a.RENDERBUFFER,g.format,f,E),a.bindRenderbuffer(a.RENDERBUFFER,x)},A=(a,T,g,f,E,x)=>{const K=a.getParameter(a.FRAMEBUFFER_BINDING);a.bindFramebuffer(a.FRAMEBUFFER,T),a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,g,0),(x.depth||x.stencil)&&a.framebufferRenderbuffer(a.FRAMEBUFFER,f.attachment,a.RENDERBUFFER,E),a.bindFramebuffer(a.FRAMEBUFFER,K)};d(e,u,v,_,n),n.addEventListener("on-config-changed",()=>d(e,u,v,_,n)),A(e,F,u,_,v,o);const I=`
		attribute vec2 a_position;
		varying vec2 v_texcoord;
		void main() {
			// \u5F52\u4E00\u5316, \u5C06\u9876\u70B9\u5750\u6807\u4ECE [-1, 1] -> [0, 1]
		  gl_Position = vec4(a_position * 2.0 - 1.0, 0.0, 1.0);
		  v_texcoord = a_position;
		}
	  `;function y(a,T,g){const f=a.createShader(T);return a.shaderSource(f,g),a.compileShader(f),a.getShaderParameter(f,a.COMPILE_STATUS)?f:(console.warn(a.getShaderInfoLog(f)),null)}function m(a,T,g){let f=a.createProgram();const E=y(a,a.VERTEX_SHADER,T),x=y(a,a.FRAGMENT_SHADER,g);return E===null||x===null?(console.error("There was a problem with shader construction"),null):(a.attachShader(f,E),a.attachShader(f,x),a.linkProgram(f),a.getProgramParameter(f,a.LINK_STATUS)?f:(console.warn(a.getProgramInfoLog(f)),null))}let X,N,M,b;const P=(a,T,g)=>{const f=g(T);if(f===N)return;N=f;const E=y(a,a.FRAGMENT_SHADER,f);if(E===null)return;X&&a.deleteShader(X),X=E;const x=m(a,I,f);if(x===null){console.warn("There was a problem with shader construction");return}M=a.getAttribLocation(x,"a_position"),b=a.getUniformLocation(x,"u_viewType");const K=a.getUniformLocation(x,"u_texture"),Ve=a.getParameter(a.CURRENT_PROGRAM);a.useProgram(x),a.uniform1i(K,0),a.useProgram(Ve),U&&a.deleteProgram(U),U=x};console.log(H.Shader(n));let U=m(e,I,H.Shader(n));U===null&&console.warn("There was a problem with shader construction"),n.addEventListener("on-config-changed",()=>{P(e,n,H.Shader)});const te=p?p.createVertexArrayOES():e.createVertexArray(),xe=e.createBuffer(),ke=e.getParameter(e.ARRAY_BUFFER_BINDING),Le=e.getParameter(s);c(te),e.bindBuffer(e.ARRAY_BUFFER,xe),e.bufferData(e.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),e.STATIC_DRAW),e.enableVertexAttribArray(M),e.vertexAttribPointer(M,2,e.FLOAT,!1,0,0),c(Le),e.bindBuffer(e.ARRAY_BUFFER,ke);const Se=()=>{console.assert(this[D].LookingGlassEnabled),e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffer);const a=e.getParameter(e.COLOR_CLEAR_VALUE),T=e.getParameter(e.DEPTH_CLEAR_VALUE),g=e.getParameter(e.STENCIL_CLEAR_VALUE);e.clearColor(0,0,0,0),e.clearDepth(1),e.clearStencil(0),e.clear(e.DEPTH_BUFFER_BIT|e.COLOR_BUFFER_BIT|e.STENCIL_BUFFER_BIT),e.clearColor(a[0],a[1],a[2],a[3]),e.clearDepth(T),e.clearStencil(g)};function Pe(){if(!n.appCanvas||!n.lkgCanvas)return;(n.appCanvas.width!==n.framebufferWidth||n.appCanvas.height!==n.framebufferHeight)&&(n.appCanvas.width,n.appCanvas.height,n.appCanvas.width=n.framebufferWidth,n.appCanvas.height=n.framebufferHeight);const a=Ie();De(),Ae(),Be(),Me(),Fe(a)}function Fe(a){e.activeTexture(a.activeTexture),e.bindTexture(e.TEXTURE_2D,a.textureBinding),e.useProgram(a.program),e.bindRenderbuffer(e.RENDERBUFFER,a.renderbufferBinding),e.bindFramebuffer(e.FRAMEBUFFER,a.framebufferBinding),a.scissorTest?e.enable(e.SCISSOR_TEST):e.disable(e.SCISSOR_TEST),a.stencilTest?e.enable(e.STENCIL_TEST):e.disable(e.STENCIL_TEST),a.depthTest?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),a.blend?e.enable(e.BLEND):e.disable(e.BLEND),a.cullFace?e.enable(e.CULL_FACE):e.disable(e.CULL_FACE),c(a.VAO)}function Ie(){return{VAO:e.getParameter(e.VERTEX_ARRAY_BINDING),cullFace:e.getParameter(e.CULL_FACE),blend:e.getParameter(e.BLEND),depthTest:e.getParameter(e.DEPTH_TEST),stencilTest:e.getParameter(e.STENCIL_TEST),scissorTest:e.getParameter(e.SCISSOR_TEST),viewport:e.getParameter(e.VIEWPORT),framebufferBinding:e.getParameter(e.FRAMEBUFFER_BINDING),renderbufferBinding:e.getParameter(e.RENDERBUFFER_BINDING),program:e.getParameter(e.CURRENT_PROGRAM),activeTexture:e.getParameter(e.ACTIVE_TEXTURE),textureBinding:e.getParameter(e.TEXTURE_BINDING_2D)}}function De(){e.bindFramebuffer(e.FRAMEBUFFER,null),e.useProgram(U),c(te),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,u),e.disable(e.BLEND),e.disable(e.CULL_FACE),e.disable(e.DEPTH_TEST),e.disable(e.STENCIL_TEST),e.viewport(0,0,e.drawingBufferWidth,e.drawingBufferHeight)}function Ae(){e.uniform1i(b,0),e.drawArrays(e.TRIANGLES,0,6)}function Be(){if(!n.lkgCanvas||!n.appCanvas){console.warn("Looking Glass Canvas is not defined");return}l==null||l.clearRect(0,0,n.lkgCanvas.width,n.lkgCanvas.height),l==null||l.drawImage(n.appCanvas,0,0,n.framebufferWidth,n.framebufferHeight,0,0,n.calibration.screenW.value,n.calibration.screenH.value)}function Me(){if(!n.appCanvas){console.warn("Looking Glass Canvas is not defined");return}n.inlineView!==0&&(n.capturing&&n.appCanvas.width!==n.framebufferWidth&&(n.appCanvas.width=n.framebufferWidth,n.appCanvas.height=n.framebufferHeight,e.viewport(0,0,n.framebufferHeight,n.framebufferWidth)),e.uniform1i(b,n.inlineView),e.drawArrays(e.TRIANGLES,0,6))}window.addEventListener("unload",()=>{n.popup&&n.popup.close(),n.popup=null}),this[D]={LookingGlassEnabled:!1,framebuffer:F,clearFramebuffer:Se,blitTextureToDefaultFramebufferIfNeeded:Pe,moveCanvasToWindow:be}}get framebuffer(){return this[D].LookingGlassEnabled?this[D].framebuffer:null}get framebufferWidth(){return S().framebufferWidth}get framebufferHeight(){return S().framebufferHeight}}const G=class extends ce.default{constructor(i){super(i),this.sessions=new Map,this.viewSpaces=[],this.basePoseMatrix=w.mat4.create(),this.inlineProjectionMatrix=w.mat4.create(),this.inlineInverseViewMatrix=w.mat4.create(),this.LookingGlassProjectionMatrices=[],this.LookingGlassInverseViewMatrices=[],this.captureScreenshot=!1,this.screenshotCallback=null,G.instance||(G.instance=this)}static getInstance(){return G.instance}onBaseLayerSet(i,e){const r=this.sessions.get(i);r.baseLayer=e;const n=S(),l=e[D];l.LookingGlassEnabled=r.immersive,r.immersive&&(n.XRSession=this.sessions.get(i),n.popup==null?l.moveCanvasToWindow(!0,()=>{this.endSession(i)}):console.warn("attempted to assign baselayer twice?"))}isSessionSupported(i){return i==="inline"||i==="immersive-vr"}isFeatureSupported(i){switch(i){case"viewer":return!0;case"local":return!0;case"local-floor":return!0;case"bounded-floor":return!1;case"unbounded":return!1;default:return console.warn("LookingGlassXRDevice.isFeatureSupported: feature not understood:",i),!1}}async requestSession(i,e){if(!this.isSessionSupported(i))return Promise.reject();const r=i!=="inline",n=new Ee(i,e);return this.sessions.set(n.id,n),r&&this.dispatchEvent("@@@lookingglass/webxr-polyfill/vr-present-start",n.id),Promise.resolve(n.id)}requestAnimationFrame(i){return this.global.requestAnimationFrame(i)}cancelAnimationFrame(i){this.global.cancelAnimationFrame(i)}onFrameStart(i,e){const r=this.sessions.get(i),n=S(),l=10,o=this.getCameraDis(48,l,52);if(r.immersive){let u=0;for(let _=0;_<n.numViews;++_){let F=-o*24+u*o;F>o*24&&(F=-o*24,u=0);const p=w.vec3.fromValues(F,0,l),s=w.vec3.fromValues(F,0,0),c=w.vec3.fromValues(0,1,0),d=this.LookingGlassProjectionMatrices[_]=this.LookingGlassProjectionMatrices[_]||w.mat4.create();w.mat4.lookAt(d,p,s,c),w.mat4.perspective(d,n.fovy,1536/2048,1,20)}r.baseLayer[D].clearFramebuffer()}else{const u=r.baseLayer.context,v=u.drawingBufferWidth/u.drawingBufferHeight;w.mat4.perspective(this.inlineProjectionMatrix,e.inlineVerticalFieldOfView,v,e.depthNear,e.depthFar),w.mat4.fromTranslation(this.basePoseMatrix,[0,q,0]),w.mat4.invert(this.inlineInverseViewMatrix,this.basePoseMatrix)}}getCameraDis(i,e,r){return 2*e*Math.tan(r/2*Math.PI/180)/(i-1)}onFrameEnd(i){this.sessions.get(i).baseLayer[D].blitTextureToDefaultFramebufferIfNeeded(),this.captureScreenshot&&this.screenshotCallback&&(this.screenshotCallback(),this.captureScreenshot=!1)}async requestFrameOfReferenceTransform(i,e){const r=w.mat4.create();switch(i){case"viewer":case"local":return w.mat4.fromTranslation(r,[0,-q,0]),r;case"local-floor":return r;default:throw new Error("XRReferenceSpaceType not understood")}}endSession(i){const e=this.sessions.get(i);e.immersive&&e.baseLayer&&(e.baseLayer[D].moveCanvasToWindow(!1),this.dispatchEvent("@@@lookingglass/webxr-polyfill/vr-present-end",i)),e.ended=!0}doesSessionSupportReferenceSpace(i,e){const r=this.sessions.get(i);return r.ended?!1:r.enabledFeatures.has(e)}getViewSpaces(i){if(i==="immersive-vr"){const e=S();for(let r=this.viewSpaces.length;r<e.numViews;++r)this.viewSpaces[r]=new Ce(r);return this.viewSpaces.length=e.numViews,this.viewSpaces}}getViewport(i,e,r,n,l){if(l===void 0){const u=this.sessions.get(i).baseLayer.context;n.x=0,n.y=0,n.width=u.drawingBufferWidth,n.height=u.drawingBufferHeight}else{const o=S(),u=l%o.quiltWidth,v=Math.floor(l/o.quiltWidth);n.x=o.framebufferWidth/o.quiltWidth*u,n.y=o.framebufferHeight/o.quiltHeight*v,n.width=o.framebufferWidth/o.quiltWidth,n.height=o.framebufferHeight/o.quiltHeight}return!0}getProjectionMatrix(i,e){return e===void 0?this.inlineProjectionMatrix:this.LookingGlassProjectionMatrices[e]||w.mat4.create()}getBasePoseMatrix(){return this.basePoseMatrix}getBaseViewMatrix(){return this.inlineInverseViewMatrix}_getViewMatrixByIndex(i){return this.LookingGlassInverseViewMatrices[i]=this.LookingGlassInverseViewMatrices[i]||w.mat4.create()}getInputSources(){return[]}getInputPose(i,e,r){return null}onWindowResize(){}};let W=G;C(W,"instance",null);let ge=0;class Ee{constructor(i,e){C(this,"mode");C(this,"immersive");C(this,"id");C(this,"baseLayer");C(this,"inlineVerticalFieldOfView");C(this,"ended");C(this,"enabledFeatures");this.mode=i,this.immersive=i==="immersive-vr"||i==="immersive-ar",this.id=++ge,this.baseLayer=null,this.inlineVerticalFieldOfView=Math.PI*.5,this.ended=!1,this.enabledFeatures=e}}class Ce extends ue.default{constructor(e){super();C(this,"viewIndex");this.viewIndex=e}get eye(){return"none"}_onPoseUpdate(e){this._inverseBaseMatrix=e._getViewMatrixByIndex(this.viewIndex)}}class z extends oe.default{constructor(e){super();C(this,"vrButton");C(this,"device");C(this,"isPresenting",!1);Q(e),this.loadPolyfill()}static async init(e){new z(e)}async loadPolyfill(){this.overrideDefaultVRButton(),console.warn('Looking Glass WebXR "polyfill" overriding native WebXR API.');for(const e in Z.default)this.global[e]=Z.default[e];this.global.XRWebGLLayer=ye,this.injected=!0,this.device=new W(this.global),this.xr=new se.default(Promise.resolve(this.device)),Object.defineProperty(this.global.navigator,"xr",{value:this.xr,configurable:!0})}async overrideDefaultVRButton(){this.vrButton=await Re("VRButton"),this.vrButton&&this.device?(this.device.addEventListener("@@webxr-polyfill/vr-present-start",()=>{this.isPresenting=!0,this.updateVRButtonUI()}),this.device.addEventListener("@@webxr-polyfill/vr-present-end",()=>{this.isPresenting=!1,this.updateVRButtonUI()}),this.vrButton.addEventListener("click",e=>{console.log("button click",e),this.updateVRButtonUI()}),this.updateVRButtonUI()):console.warn("Unable to find VRButton")}async updateVRButtonUI(){if(this.vrButton){await Te(100),this.isPresenting?this.vrButton.innerHTML="EXIT LOOKING GLASS":this.vrButton.innerHTML="ENTER LOOKING GLASS";const e=220;this.vrButton.style.width=`${e}px`,this.vrButton.style.left=`calc(50% - ${e/2}px)`}}update(e){Q(e)}}async function Re(t){return new Promise(i=>{const e=new MutationObserver(function(r){r.forEach(function(n){n.addedNodes.forEach(function(l){const o=l;o.id===t&&(i(o),e.disconnect())})})});e.observe(document.body,{subtree:!1,childList:!0}),setTimeout(()=>{e.disconnect(),i(null)},5e3)})}function Te(t){return new Promise(i=>setTimeout(i,t))}const _e=S();h.LookingGlassConfig=_e,h.LookingGlassWebXRPolyfill=z,Object.defineProperties(h,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
